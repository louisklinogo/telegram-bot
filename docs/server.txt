
paco@paco MINGW64 ~/Projects/invoice/telegram-bot (master)
$ bun src/server.ts
WARN [2025-09-28 19:27:18.661 +0000] (Cimantikos-Bot): If you are using a custom instrumentation file or want to disable this warning, set the globalThis.___MASTRA_TELEMETRY___ variable to true in your instrumentation file.
CloudExporter disabled: MASTRA_CLOUD_ACCESS_TOKEN environment variable not set. üöÄ Sign up for Mastra Cloud at https://cloud.mastra.ai to see your AI traces online and obtain your access token.
AI tracing exporter initialized {
  strategy: "batch-with-updates",
  source: "auto",
  storageAdapter: "",
  maxBatchSize: 1000,
  maxBatchWaitMs: 5000,
}
üîç Validating environment variables...
‚úÖ Environment validation passed
   Environment: development
   Server port: 8080
   Webhook configured: Yes
   API keys loaded: 8 keys

‚úÖ Cloudinary configured successfully
   Cloud name: dk4b0brc0
üöÄ Starting Cimantik√≥s Telegram Bot Server...
üì° Main server (Telegram webhooks): http://localhost:8080

üîí Security Status:
   Environment: development
   Webhook secret: Configured
   API keys: 5 loaded

‚úÖ Main Telegram server is running!
üìä Main health check: http://localhost:8080/health
üîó Telegram webhook: http://localhost:8080/webhook
ü§ñ API endpoint: http://localhost:8080/api/telegram/process-message
üß† Agent status: http://localhost:8080/api/telegram/agent/status

‚ö†Ô∏è  IMPORTANT: You must also run "mastra dev" in a separate terminal for AI agents to work!
üß† Mastra server should be running on: http://localhost:4111
üîó Setting up webhook to: https://8b03d45504dd.ngrok-free.app/webhook
‚úÖ Webhook configured successfully
üì® Webhook: private 8168118983 - unknown (8168118983)
   Text: hi
ü§ñ Starting agent processing for user 8168118983
üîß Preprocessing workflow input data...
üìä Parsed 2 items: Trainway Suit (1x GHS 2000), Prexor Suit (1x GHS 2000)
Generating invoice for: Moses Bekoe
Invoice generated: C:\Users\louis\Projects\invoice\telegram-bot\invoice-pdfs\invoice_moses_bekoe_2025-09-28T19-27-36-644Z.pdf
üì§ Uploading PDF to Cloudinary...
‚òÅÔ∏è Uploading to Cloudinary with options: {
  resource_type: "raw",
  folder: "cimantikos-invoices",
  use_filename: false,
  unique_filename: true,
  overwrite: false,
  access_mode: "public",
  type: "upload",
  public_id: "invoice_moses_bekoe_2025-09-28T19-27-36-644Z",
}
‚úÖ File uploaded to Cloudinary: cimantikos-invoices/invoice_moses_bekoe_2025-09-28T19-27-36-644Z.pdf
‚úÖ PDF uploaded to Cloudinary: https://res.cloudinary.com/dk4b0brc0/raw/upload/v1759087658/cimantikos-invoices/invoice_moses_bekoe_2025-09-28T19-27-36-644Z.pdf
üïí Allowing Cloudinary processing time...
Webhook error: 57 |         return task;
58 |     return new Promise((resolve, reject) => {
59 |         const handle = setTimeout(() => {
60 |             debugErr(`Request timed out after ${timeout} ms`);
61 |             if (onTimeout === "throw") {
62 |                 reject(new Error(`Request timed out after ${timeout} ms`));
                            ^
error: Request timed out after 10000 ms
      at <anonymous> (C:\Users\louis\Projects\invoice\telegram-bot\node_modules\grammy\out\convenience\webhook.js:62:24)

Invoice generated successfully: invoice_moses_bekoe_2025-09-28T19-27-36-644Z.pdf
Creating Notion invoice for: Moses Bekoe
Notion client creation failed with status 400: {"object":"error","status":400,"code":"validation_error","message":"body failed validation. Fix one:\nbody.properties.Name.id should be defined, instead was `undefined`.\nbody.properties.Name.name should be defined, instead was `undefined`.\nbody.properties.Name.start should be defined, instead was `undefined`.","request_id":"edbe2650-0e7e-4128-85cf-078d34188190"}
Error finding/creating client: 327 |       return clientPage;
328 |     } else {
329 |       // Get detailed error information
330 |       const errorText = await createResponse.text();
331 |       console.error(`Notion client creation failed with status ${createResponse.status}:`, errorText);
332 |       throw new Error(`Failed to create new client: ${createResponse.status} - ${errorText}`);
                  ^
error: Failed to create new client: 400 - {"object":"error","status":400,"code":"validation_error","message":"body failed validation. Fix one:\nbody.properties.Name.id should be defined, instead was `undefined`.\nbody.properties.Name.name should be defined, instead was `undefined`.\nbody.properties.Name.start should be defined, instead was `undefined`.","request_id":"edbe2650-0e7e-4128-85cf-078d34188190"}
      at findOrCreateClient (C:\Users\louis\Projects\invoice\telegram-bot\src\mastra\tools\notionOrdersTool.ts:332:13)

Error creating order in Notion: 327 |       return clientPage;
328 |     } else {
329 |       // Get detailed error information
330 |       const errorText = await createResponse.text();
331 |       console.error(`Notion client creation failed with status ${createResponse.status}:`, errorText);
332 |       throw new Error(`Failed to create new client: ${createResponse.status} - ${errorText}`);
                  ^
error: Failed to create new client: 400 - {"object":"error","status":400,"code":"validation_error","message":"body failed validation. Fix one:\nbody.properties.Name.id should be defined, instead was `undefined`.\nbody.properties.Name.name should be defined, instead was `undefined`.\nbody.properties.Name.start should be defined, instead was `undefined`.","request_id":"edbe2650-0e7e-4128-85cf-078d34188190"}
      at findOrCreateClient (C:\Users\louis\Projects\invoice\telegram-bot\src\mastra\tools\notionOrdersTool.ts:332:13)

Notion invoice creation failed: Failed to create new client: 400 - {"object":"error","status":400,"code":"validation_error","message":"body failed validation. Fix one:\nbody.properties.Name.id should be defined, instead was `undefined`.\nbody.properties.Name.name should be defined, instead was `undefined`.\nbody.properties.Name.start should be defined, instead was `undefined`.","request_id":"edbe2650-0e7e-4128-85cf-078d34188190"}
üì§ Sending PDF invoice to customer: Moses Bekoe
üîç Using chat_id: 8168118983 for PDF delivery
üì§ Sending PDF from Cloudinary URL: https://res.cloudinary.com/dk4b0brc0/raw/upload/v1759087658/cimantikos-invoices/invoice_moses_bekoe_2025-09-28T19-27-36-644Z.pdf
üîç Testing Cloudinary URL accessibility (attempt 1/3)...
‚ö†Ô∏è Cloudinary URL not accessible (attempt 1/3), status: 401
üîÑ Trying GET request instead of HEAD...
üîç Testing Cloudinary URL accessibility (attempt 2/3)...
‚ö†Ô∏è Cloudinary URL not accessible (attempt 2/3), status: 401
üîÑ Trying GET request instead of HEAD...
üîç Testing Cloudinary URL accessibility (attempt 3/3)...
‚ö†Ô∏è Cloudinary URL not accessible (attempt 3/3), status: 401
‚ùå Cloudinary URL test failed after all attempts: 72 |             if (urlTest.ok) {
73 |               console.log(`‚úÖ Cloudinary URL is accessible (attempt ${attempt})`);
74 |               urlTestSuccessful = true;
75 |               break;
76 |             } else {
77 |               lastError = new Error(`Cloudinary URL returned status ${urlTest.status}`);
                               ^
error: Cloudinary URL returned status 401
      at <anonymous> (C:\Users\louis\Projects\invoice\telegram-bot\src\mastra\tools\pdfSender.ts:77:27)

üîÑ Falling back to local file: C:\Users\louis\Projects\invoice\telegram-bot\invoice-pdfs\invoice_moses_bekoe_2025-09-28T19-27-36-644Z.pdf
üì§ Sending PDF from local file: C:\Users\louis\Projects\invoice\telegram-bot\invoice-pdfs\invoice_moses_bekoe_2025-09-28T19-27-36-644Z.pdf
‚úÖ PDF invoice delivered successfully to user: Moses Bekoe
‚úÖ Agent processing completed in 30419ms
Processed message for user 8168118983: 4 steps, 22980 tokens
üßπ Local PDF file cleaned up after Cloudinary upload
